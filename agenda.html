<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda Digital </title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
/* ===================== VARI√ÅVEIS ===================== */
:root{
  --bg:#08060a;
  --surface:#121018;
  --muted:#bfb7d6;
  --accent:#8a46ff;
  --accent-2:#c39bff;
  --card:#161319;
  --radius:14px;
  --gap:18px;
}

/* ===================== RESET ===================== */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI', Poppins, system-ui;
  background: linear-gradient(180deg,var(--bg),#050205);
  color:#fff;
  -webkit-font-smoothing:antialiased;
  padding:20px;
  display:flex;
  justify-content:center;
}
.container{
  background: var(--surface);
  border-radius: var(--radius);
  padding:25px 20px;
  width:100%;
  max-width:480px;
  box-shadow:0 6px 25px rgba(0,0,0,0.3);
}

/* ===================== LOGO ===================== */
h1{
  text-align:center;
  margin-bottom:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:2rem;
  color: var(--accent-2);
}
h1 img{
  width:95px;
  height:95px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid var(--accent);
}

/* ===================== FORMUL√ÅRIO ===================== */
label{
  display:block;
  margin-bottom:5px;
  font-weight:600;
  color: var(--accent-2);
}
input, select{
  width:100%;
  padding:12px;
  font-size:1rem;
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,0.1);
  background: var(--card);
  color:#fff;
  margin-bottom:12px;
}
input:focus, select:focus{
  outline:none;
  border-color: var(--accent);
}
input[readonly]{
  background:#1a1622;
  color:#aaa;
  cursor:not-allowed;
}
button{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  font-weight:bold;
  border:none;
  padding:12px;
  border-radius: var(--radius);
  cursor:pointer;
  transition:0.3s;
}
button:hover{
  background: linear-gradient(90deg,var(--accent-2),var(--accent));
}

/* ===================== QUADRO DE HOR√ÅRIOS ===================== */
#quadro-horarios{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:5px;
}
.horario{
  flex:1 0 30%;
  text-align:center;
  padding:10px 12px;
  border-radius: var(--radius);
  cursor:pointer;
  background:#33004d;
  color:#fff;
  border:1px solid var(--accent);
  font-weight:600;
  transition:0.2s;
}
.horario.ocupado{
  background:#4b004b;
  border-color:#ff33cc;
  cursor:not-allowed;
  color:#999;
}
.horario.selecionado{
  background: var(--accent);
  color:#fff;
}

/* ===================== AGENDAMENTOS ===================== */
h2{
  margin-bottom:15px;
  color: var(--accent-2);
  font-size:1.5rem;
  border-bottom:1px solid rgba(255,255,255,0.1);
  padding-bottom:5px;
}
ul{
  list-style:none;
  padding:0;
  margin:0;
}
.dia{
  background:#33004d;
  color: #fff;
  font-weight:bold;
  padding:8px 12px;
  border-radius: var(--radius);
  margin-top:20px;
  font-size:1.1rem;
}
.horario-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1a1622;
  padding:10px 12px;
  margin-top:8px;
  border-radius: var(--radius);
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
  font-size:0.95rem;
  transition:0.2s;
}
.horario-item:hover{
  background:#2e1f49;
}
.horario-item span{
  font-weight:600;
  color:#fff;
  flex-grow:1;
}

/* ===================== RESPONSIVIDADE ===================== */
/* === MOBILE (at√© 480px) === */
@media (max-width: 480px) {

  body {
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    background-size: cover;
    background-position: center;
  }

  /* Container do formul√°rio (card) */
  .container,
  .agenda-box,
  .card {
    width: 92% !important;
    max-width: 360px;
    margin: 20px auto !important;
    transform: none !important;
    left: 0 !important;
  }

  h1 {
    font-size: 1.6rem !important;
    text-align: center;
  }

  h1 img {
    width: 70px;
    height: 70px;
  }

  /* Inputs */
  input, select, button {
    font-size: 1rem !important;
    padding: 10px !important;
  }

  .horario {
    flex: 1 0 100%;
    font-size: 0.95rem;
  }

  .horario-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .horario-item button {
    align-self: flex-end;
  }

  /* Bot√µes */
  button {
    width: 100%;
  }
}

</style>
</head>
<body>
<div class="container">
<h1> Agenda Digital</h1>

<form id="form-agenda">
  <label>Nome do Cliente</label>
  <input type="text" id="nome" readonly />

  <label>Tran√ßa Escolhida</label>
  <input type="text" id="trancaEscolhida" readonly />

  <label for="data">Selecione uma data</label>
  <input type="date" id="data" required />

  <input type="hidden" id="horario" required />
  <div id="quadro-horarios"></div>
  <button type="submit">Agendar</button>
</form>

<h2>Agendamentos</h2>
<ul id="lista"></ul>
</div>
<script>
const SUPABASE_URL = "https://zlifgtznogdejoibzmpu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsaWZndHpub2dkZWpvaWJ6bXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTQyMTgsImV4cCI6MjA3NDkzMDIxOH0.Xn4SvzKEy5SPVuObgWJK6BbAzw5twCtUyrcO4sg9pPM";
const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

// LOGIN
const tipoUsuario = sessionStorage.getItem("tipoUsuario");
const nomeCliente = sessionStorage.getItem("nomeCliente") || "";

if (!tipoUsuario) window.location.href = "login.html";

window.addEventListener("beforeunload", () => {
    sessionStorage.removeItem("tipoUsuario");
    sessionStorage.removeItem("nomeCliente");
    sessionStorage.removeItem("numeroCliente");
});

// VARI√ÅVEIS
const form = document.getElementById("form-agenda");
const lista = document.getElementById("lista");
const dataInput = document.getElementById("data");
const nomeInput = document.getElementById("nome");
const quadro = document.getElementById("quadro-horarios");
const horarioInput = document.getElementById("horario");

if (tipoUsuario === "cliente") nomeInput.value = nomeCliente;
if (tipoUsuario === "admin") form.style.display = "none";

const horariosPadrao = [
    "09:00","10:00","11:00","12:00",
    "13:00","14:00","15:00","16:00","17:00"
];

let horarioSelecionado = null;

// FORMATADOR PARA SALVAR HOR√ÅRIO LOCAL (SEM UTC)
function formatarLocal(ano, mes, dia, hora, minuto) {
    return `${ano}-${String(mes).padStart(2, "0")}-${String(dia).padStart(2, "0")} ` +
           `${String(hora).padStart(2, "0")}:${String(minuto).padStart(2,"0")}:00`;
}

// ATUALIZAR QUADRO
async function atualizarQuadro() {
    if (tipoUsuario === "admin") return;

    const dataEscolhida = dataInput.value;
    if (!dataEscolhida) {
        quadro.innerHTML = "";
        return;
    }

    // Buscar todos da data
    const { data: agendamentos } = await client
        .from("agendamentos")
        .select("*")
        .gte("horario", dataEscolhida + " 00:00:00")
        .lt("horario", dataEscolhida + " 23:59:59");

    quadro.innerHTML = "";

    const ocupados = agendamentos.map(a =>
        a.horario.slice(11, 16) // pega HH:MM
    );

    horariosPadrao.forEach(h => {
        const div = document.createElement("div");
        div.classList.add("horario");
        div.textContent = h;

        if (ocupados.includes(h)) {
            div.classList.add("ocupado");
        } else {
            div.addEventListener("click", () => {

                quadro.querySelectorAll(".selecionado")
                      .forEach(el => el.classList.remove("selecionado"));

                div.classList.add("selecionado");
                horarioSelecionado = h;

                const [ano, mes, dia] = dataEscolhida.split("-");
                const [hora, min] = h.split(":");

                // SALVAR SEM UTC
                horarioInput.value = formatarLocal(ano, mes, dia, hora, min);
            });
        }

        quadro.appendChild(div);
    });
}

dataInput.addEventListener("change", () => {
    horarioSelecionado = null;
    horarioInput.value = "";
    atualizarQuadro();
});

// CALCULAR HOR√ÅRIO FINAL (AINDA LOCAL)
function somarHorasLocal(inicioStr, duracaoBase, tempoExtra) {
    let dt = new Date(inicioStr.replace(" ", "T"));

    let somaMs = (duracaoBase + tempoExtra) * 60 * 60 * 1000;
    let fim = new Date(dt.getTime() + somaMs);

    return formatarLocal(
        fim.getFullYear(),
        fim.getMonth() + 1,
        fim.getDate(),
        fim.getHours(),
        fim.getMinutes()
    );
}

// SUBMIT
form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!horarioSelecionado) {
        alert("Selecione um hor√°rio!");
        return;
    }

    const nome = nomeInput.value;
    const dataEscolhida = dataInput.value;

    const tranca = document.getElementById("opTranca").value;
    const comprimento = parseFloat(document.getElementById("opComprimento").value);
    const cor = document.getElementById("opCor").value;
    const espessura = parseFloat(document.getElementById("opEspessura").value);
    const tempoExtra = Number(document.getElementById("opEspessura").selectedOptions[0].dataset.tempo || 0);

    const preco = window.totalPrice || 0;
    const extras = window.extrasSelecionados || [];
    const duracaoBase = window.duracaoTrancaBase || 2;

    let horarioInicio = horarioInput.value;
    let horarioFim = somarHorasLocal(horarioInicio, duracaoBase, tempoExtra);

    const { error } = await client.from("agendamentos").insert([{
        nome_cliente: nome,
        tranca,
        comprimento,
        cor,
        espessura,
        preco,
        extras,
        tempo_extra: tempoExtra,
        dados: { tranca, comprimento, espessura, extras },
        horario: horarioInicio,
        horario_fim: horarioFim,
        status: "pendente"
    }]);

    if (error) {
        alert("Erro: " + error.message);
        return;
    }

    alert("Agendado com sucesso!");

    form.reset();
    horarioSelecionado = null;
    quadro.innerHTML = "";
    carregarAgendamentos();
});

// LISTAR
async function carregarAgendamentos() {
    const { data } = await client
        .from("agendamentos")
        .select("*")
        .order("horario", { ascending: true });

    lista.innerHTML = "";
    if (!data) return;

    let ultimoDia = "";

    data.forEach(a => {
        if (tipoUsuario === "cliente" &&
            a.nome_cliente.toLowerCase() !== nomeCliente.toLowerCase()) return;

        const dia = a.horario.slice(0, 10);
        const hora = a.horario.slice(11, 16);

        if (dia !== ultimoDia) {
            const liDia = document.createElement("li");
            liDia.textContent = dia.split("-").reverse().join("/");
            liDia.classList.add("dia");
            lista.appendChild(liDia);
            ultimoDia = dia;
        }

        const li = document.createElement("li");
        li.classList.add("horario-item");

        li.innerHTML = `
            <span>${a.nome_cliente} ‚Äî ${hora} ‚Äî [${a.status}]</span>
        `;

        if (tipoUsuario === "admin") {
            const btnEditar = document.createElement("button");
            btnEditar.textContent = "‚úèÔ∏è";
            btnEditar.onclick = () => {
                const novoNome = prompt("Novo nome:", a.nome_cliente);
                if (novoNome)
                    client.from("agendamentos")
                        .update({ nome_cliente: novoNome })
                        .eq("id", a.id)
                        .then(() => carregarAgendamentos());
            };

            const btnExcluir = document.createElement("button");
            btnExcluir.textContent = "üóëÔ∏è";
            btnExcluir.onclick = () => {
                if (confirm("Excluir agendamento?"))
                    client.from("agendamentos")
                        .delete()
                        .eq("id", a.id)
                        .then(() => carregarAgendamentos());
            };

            li.appendChild(btnEditar);
            li.appendChild(btnExcluir);
        }

        lista.appendChild(li);
    });
}

carregarAgendamentos();
atualizarQuadro();

</script>






</body>
</html>
